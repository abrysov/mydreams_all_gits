#!/bin/bash
#
# Generated by Ansible
# Local modification will be overwritten.
#

# Settings
APP_ROOT={{ dreams_web_base_dir }}
APP_USER={{ dreams_deploy_user.name }}
APP_GROUP={{ dreams_deploy_user.name }}
APP_RAILS_ENV='{{ dreams_env }}'

PUMA_CONFIG="$APP_ROOT/current/config/puma.rb"
CMD="bundle exec puma -C $PUMA_CONFIG -t {{ item.min_threads }}:{{ item.max_threads }} -w {{ item.workers }} --preload"
CHPSTKEY="-u ${APP_USER}:${APP_GROUP}"


# Set environment variables
export RAILS_ENV=$APP_RAILS_ENV
export PUMA_PORT={{ item.port }}
export PUMA_MIN_THREADS={{ item.min_threads }}
export PUMA_MAX_THREADS={{ item.max_threads }}
export PUMA_WORKERS={{ item.workers }}
export PUMA_BACKLOG={{ item.backlog }}
export PATH=/home/{{ dreams_deploy_user.name }}/.rbenv/shims:/home/{{ dreams_deploy_user.name }}/.rbenv/bin:$PATH

cd ${APP_ROOT}/current

# Run
exec 2>&1
echo "Running Dreams web server..."
exec chpst $CHPSTKEY $CMD
